

<!DOCTYPE html>
<html lang="en" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/fluid.png">
  <link rel="icon" href="/img/fluid.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="WYX ">
  <meta name="keywords" content="">
  
    <meta name="description" content="34 | 编程范式游记（5）- 修饰器模式你好，我是陈皓，网名左耳朵耗子。 在上一讲中，我们领略了函数式编程的趣味和魅力，主要讲了函数式编程的主要技术。还记得有哪些吗？递归、Map、Reduce、Filter等，并利用Python的Decorator和Generator功能，将多个函数组合成了管道。 此时，你心中可能会有个疑问，这个decorator又是怎样工作的呢？这就是本文中要讲述的内容，“D">
<meta property="og:type" content="article">
<meta property="og:title" content="WYX同学的Blog">
<meta property="og:url" content="http://example.com/2023/05/16/34-%E7%BC%96%E7%A8%8B%E8%8C%83%E5%BC%8F%E6%B8%B8%E8%AE%B0%EF%BC%885%EF%BC%89-%E4%BF%AE%E9%A5%B0%E5%99%A8%E6%A8%A1%E5%BC%8F/index.html">
<meta property="og:site_name" content="WYX同学的Blog">
<meta property="og:description" content="34 | 编程范式游记（5）- 修饰器模式你好，我是陈皓，网名左耳朵耗子。 在上一讲中，我们领略了函数式编程的趣味和魅力，主要讲了函数式编程的主要技术。还记得有哪些吗？递归、Map、Reduce、Filter等，并利用Python的Decorator和Generator功能，将多个函数组合成了管道。 此时，你心中可能会有个疑问，这个decorator又是怎样工作的呢？这就是本文中要讲述的内容，“D">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2023-05-16T07:46:21.624Z">
<meta property="article:modified_time" content="2023-05-16T07:46:21.630Z">
<meta property="article:author" content="WYX ">
<meta name="twitter:card" content="summary_large_image">
  
  
  
  <title>WYX同学的Blog</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  




  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"example.com","root":"/","version":"1.9.2","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":false,"follow_dnt":true,"baidu":null,"google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false}},"search_path":"/local-search.xml"};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  


  
<!-- hexo injector head_end start -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css">
<!-- hexo injector head_end end --><meta name="generator" content="Hexo 6.2.0"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>WYX&#39;s Blog</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                Home
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                Archives
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                Categories
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                Tags
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                About
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              &nbsp;<i class="iconfont icon-search"></i>&nbsp;
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">&nbsp;<i
                class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/img/default.png') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text=""></span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2023-05-16 15:46" pubdate>
          May 16, 2023 pm
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          11k words
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          88 mins
        
      </span>
    

    
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none"></h1>
            
            
              <div class="markdown-body">
                
                <h1 id="34-编程范式游记（5）-修饰器模式"><a href="#34-编程范式游记（5）-修饰器模式" class="headerlink" title="34 | 编程范式游记（5）- 修饰器模式"></a>34 | 编程范式游记（5）- 修饰器模式</h1><p>你好，我是陈皓，网名左耳朵耗子。</p>
<p>在上一讲中，我们领略了函数式编程的趣味和魅力，主要讲了函数式编程的主要技术。还记得有哪些吗？递归、Map、Reduce、Filter等，并利用Python的Decorator和Generator功能，将多个函数组合成了管道。</p>
<p>此时，你心中可能会有个疑问，这个decorator又是怎样工作的呢？这就是本文中要讲述的内容，“Decorator模式”，又叫“修饰器模式”，或是“装饰器模式”。</p>
<h1 id="Python的Decorator"><a href="#Python的Decorator" class="headerlink" title="Python的Decorator"></a>Python的Decorator</h1><p>Python的Decorator在使用上和Java的Annotation（以及C#的Attribute）很相似，就是在方法名前面加一个@XXX注解来为这个方法装饰一些东西。但是，Java/C#的Annotation也很让人望而却步，太过于复杂了。你要玩它，需要先了解一堆Annotation的类库文档，感觉几乎就是在学另外一门语言。</p>
<p>而Python使用了一种相对于Decorator Pattern和Annotation来说非常优雅的方法，这种方法不需要你去掌握什么复杂的OO模型或是Annotation的各种类库规定，完全就是语言层面的玩法：一种函数式编程的技巧。</p>
<p>这是我最喜欢的一个模式了，也是一个挺好玩儿的东西，这个模式动用了函数式编程的一个技术——用一个函数来构造另一个函数。</p>
<p>好了，我们先来点感性认识，看一个Python修饰器的Hello World代码。</p>
<figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs pgsql">def hello(fn):<br>    def <span class="hljs-keyword">wrapper</span>():<br>        print &quot;hello, %s&quot; % fn.__name__<br>        fn()<br>        print &quot;goodbye, %s&quot; % fn.__name__<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">wrapper</span><br><br>@hello<br>def Hao():<br>    print &quot;i am Hao Chen&quot;<br><br>Hao()<br><br></code></pre></td></tr></table></figure>
<p>代码的执行结果如下：</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs vim">$ <span class="hljs-keyword">python</span> hello.<span class="hljs-keyword">py</span><br>hello, Hao<br>i <span class="hljs-keyword">am</span> Hao Chen<br>goodbye, Hao<br><br></code></pre></td></tr></table></figure>
<p>你可以看到如下的东西：</p>
<ol>
<li><p>函数 <code>Hao</code> 前面有个@hello的“注解”， <code>hello</code> 就是我们前面定义的函数 <code>hello</code>；</p>
</li>
<li><p>在 <code>hello</code> 函数中，其需要一个 <code>fn</code> 的参数（这就是用来做回调的函数）；</p>
</li>
<li><p>hello函数中返回了一个inner函数 <code>wrapper</code>，这个 <code>wrapper</code> 函数回调了传进来的 <code>fn</code>，并在回调前后加了两条语句。</p>
</li>
</ol>
<p>对于Python的这个@注解语法糖（Syntactic sugar）来说，当你在用某个@decorator来修饰某个函数 <code>func</code> 时，如下所示:</p>
<figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs autoit"><span class="hljs-symbol">@decorator</span><br>def <span class="hljs-keyword">func</span><span class="hljs-params">()</span>:<br>    pass<br><br></code></pre></td></tr></table></figure>
<p>其解释器会解释成下面这样的语句：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> = <span class="hljs-title">decorator</span><span class="hljs-params">(<span class="hljs-keyword">func</span>)</span></span><br><br></code></pre></td></tr></table></figure>
<p>嘿！这不就是把一个函数当参数传到另一个函数中，然后再回调吗？是的。但是，我们需要注意，那里还有一个赋值语句，把decorator这个函数的返回值赋值回了原来的 <code>func</code>。</p>
<p>我们再来看一个带参数的玩法：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">makeHtmlTag</span>(<span class="hljs-params">tag, *args, **kwds</span>):<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">real_decorator</span>(<span class="hljs-params">fn</span>):<br>        css_class = <span class="hljs-string">&quot; class=&#x27;&#123;0&#125;&#x27;&quot;</span>.<span class="hljs-built_in">format</span>(kwds[<span class="hljs-string">&quot;css_class&quot;</span>]) \<br>                                     <span class="hljs-keyword">if</span> <span class="hljs-string">&quot;css_class&quot;</span> <span class="hljs-keyword">in</span> kwds <span class="hljs-keyword">else</span> <span class="hljs-string">&quot;&quot;</span><br>        <span class="hljs-keyword">def</span> <span class="hljs-title function_">wrapped</span>(<span class="hljs-params">*args, **kwds</span>):<br>            <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;&lt;&quot;</span>+tag+css_class+<span class="hljs-string">&quot;&gt;&quot;</span> + fn(*args, **kwds) + <span class="hljs-string">&quot;&lt;/&quot;</span>+tag+<span class="hljs-string">&quot;&gt;&quot;</span><br>        <span class="hljs-keyword">return</span> wrapped<br>    <span class="hljs-keyword">return</span> real_decorator<br><br><span class="hljs-meta">@makeHtmlTag(<span class="hljs-params">tag=<span class="hljs-string">&quot;b&quot;</span>, css_class=<span class="hljs-string">&quot;bold_css&quot;</span></span>)</span><br><span class="hljs-meta">@makeHtmlTag(<span class="hljs-params">tag=<span class="hljs-string">&quot;i&quot;</span>, css_class=<span class="hljs-string">&quot;italic_css&quot;</span></span>)</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">hello</span>():<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;hello world&quot;</span><br><br><span class="hljs-built_in">print</span> hello()<br><br><span class="hljs-comment"># 输出：</span><br><span class="hljs-comment"># &lt;b class=&#x27;bold_css&#x27;&gt;&lt;i class=&#x27;italic_css&#x27;&gt;hello world&lt;/i&gt;&lt;/b&gt;</span><br><br></code></pre></td></tr></table></figure>
<p>在上面这个例子中，我们可以看到： <code>makeHtmlTag</code> 有两个参数。所以，为了让 <code>hello = makeHtmlTag(arg1, arg2)(hello)</code> 成功， <code>makeHtmlTag</code> 必需返回一个decorator（这就是为什么我们在 <code>makeHtmlTag</code> 中加入了 <code>real_decorator()</code>）。</p>
<p>这样一来，我们就可以进入到decorator的逻辑中去了——decorator得返回一个wrapper，wrapper里回调 <code>hello</code>。看似那个 <code>makeHtmlTag()</code> 写得层层叠叠，但是，已经了解了本质的我们觉得写得很自然。</p>
<p>我们再来看一个为其它函数加缓存的示例：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> functools <span class="hljs-keyword">import</span> wraps<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">memoization</span>(<span class="hljs-params">fn</span>):<br>    cache = &#123;&#125;<br>    miss = <span class="hljs-built_in">object</span>()<br><br><span class="hljs-meta">    @wraps(<span class="hljs-params">fn</span>)</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">wrapper</span>(<span class="hljs-params">*args</span>):<br>        result = cache.get(args, miss)<br>        <span class="hljs-keyword">if</span> result <span class="hljs-keyword">is</span> miss:<br>            result = fn(*args)<br>            cache[args] = result<br>        <span class="hljs-keyword">return</span> result<br><br>    <span class="hljs-keyword">return</span> wrapper<br><br><span class="hljs-meta">@memoization</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">fib</span>(<span class="hljs-params">n</span>):<br>    <span class="hljs-keyword">if</span> n &lt; <span class="hljs-number">2</span>:<br>        <span class="hljs-keyword">return</span> n<br>    <span class="hljs-keyword">return</span> fib(n - <span class="hljs-number">1</span>) + fib(n - <span class="hljs-number">2</span>)<br><br></code></pre></td></tr></table></figure>
<p>上面这个例子中，是一个斐波那契数列的递归算法。我们知道，这个递归是相当没有效率的，因为会重复调用。比如：我们要计算fib(5)，于是其分解成 <code>fib(4) + fib(3)</code>，而 <code>fib(4)</code> 分解成 <code>fib(3) + fib(2)</code>， <code>fib(3)</code> 又分解成 <code>fib(2) + fib(1)</code>……你可以看到，基本上来说， <code>fib(3)</code>、 <code>fib(2)</code>、 <code>fib(1)</code> 在整个递归过程中被调用了至少两次。</p>
<p>而我们用decorator，在调用函数前查询一下缓存，如果没有才调用，有了就从缓存中返回值。一下子，这个递归从二叉树式的递归成了线性的递归。 <code>wraps</code> 的作用是保证 <code>fib</code> 的函数名不被 <code>wrapper</code> 所取代。</p>
<p>除此之外，Python还支持类方式的decorator。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">myDecorator</span>(<span class="hljs-title class_ inherited__">object</span>):<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, fn</span>):<br>        <span class="hljs-built_in">print</span> <span class="hljs-string">&quot;inside myDecorator.__init__()&quot;</span><br>        self.fn = fn<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__call__</span>(<span class="hljs-params">self</span>):<br>        self.fn()<br>        <span class="hljs-built_in">print</span> <span class="hljs-string">&quot;inside myDecorator.__call__()&quot;</span><br><br><span class="hljs-meta">@myDecorator</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">aFunction</span>():<br>    <span class="hljs-built_in">print</span> <span class="hljs-string">&quot;inside aFunction()&quot;</span><br><br><span class="hljs-built_in">print</span> <span class="hljs-string">&quot;Finished decorating aFunction()&quot;</span><br><br>aFunction()<br><br><span class="hljs-comment"># 输出：</span><br><span class="hljs-comment"># inside myDecorator.__init__()</span><br><span class="hljs-comment"># Finished decorating aFunction()</span><br><span class="hljs-comment"># inside aFunction()</span><br><span class="hljs-comment"># inside myDecorator.__call__()</span><br><br></code></pre></td></tr></table></figure>
<p>上面这个示例展示了，用类的方式声明一个decorator。我们可以看到这个类中有两个成员：</p>
<ol>
<li>一个是 <code>__init__()</code>，这个方法是在我们给某个函数decorate时被调用，所以，需要有一个 <code>fn</code> 的参数，也就是被decorate的函数。</li>
<li>一个是 <code>__call__()</code>，这个方法是在我们调用被decorate的函数时被调用的。</li>
</ol>
<p>从上面的输出中，可以看到整个程序的执行顺序，这看上去要比“函数式”的方式更易读一些。</p>
<p>我们来看一个实际点的例子，下面这个示例展示了通过URL的路由来调用相关注册的函数示例：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">MyApp</span>():<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self</span>):<br>        self.func_map = &#123;&#125;<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">register</span>(<span class="hljs-params">self, name</span>):<br>        <span class="hljs-keyword">def</span> <span class="hljs-title function_">func_wrapper</span>(<span class="hljs-params">func</span>):<br>            self.func_map[name] = func<br>            <span class="hljs-keyword">return</span> func<br>        <span class="hljs-keyword">return</span> func_wrapper<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">call_method</span>(<span class="hljs-params">self, name=<span class="hljs-literal">None</span></span>):<br>        func = self.func_map.get(name, <span class="hljs-literal">None</span>)<br>        <span class="hljs-keyword">if</span> func <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:<br>            <span class="hljs-keyword">raise</span> Exception(<span class="hljs-string">&quot;No function registered against - &quot;</span> + <span class="hljs-built_in">str</span>(name))<br>        <span class="hljs-keyword">return</span> func()<br><br>app = MyApp()<br><br><span class="hljs-meta">@app.register(<span class="hljs-params"><span class="hljs-string">&#x27;/&#x27;</span></span>)</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">main_page_func</span>():<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;This is the main page.&quot;</span><br><br><span class="hljs-meta">@app.register(<span class="hljs-params"><span class="hljs-string">&#x27;/next_page&#x27;</span></span>)</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">next_page_func</span>():<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;This is the next page.&quot;</span><br><br><span class="hljs-built_in">print</span> app.call_method(<span class="hljs-string">&#x27;/&#x27;</span>)<br><span class="hljs-built_in">print</span> app.call_method(<span class="hljs-string">&#x27;/next_page&#x27;</span>)<br><br></code></pre></td></tr></table></figure>
<p>注意：上面这个示例中decorator类不是真正的decorator，其中也没有 <code>__call__()</code>，并且，wrapper返回了原函数。所以，原函数没有发生任何变化。</p>
<h1 id="Go语言的Decorator"><a href="#Go语言的Decorator" class="headerlink" title="Go语言的Decorator"></a>Go语言的Decorator</h1><p>Python有语法糖，所以写出来的代码比较酷。但是对于没有修饰器语法糖这类语言，写出来的代码会是怎么样的？我们来看一下Go语言的代码。</p>
<p>还是从一个Hello World开始。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> main<br><br><span class="hljs-keyword">import</span> <span class="hljs-string">&quot;fmt&quot;</span><br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">decorator</span><span class="hljs-params">(f <span class="hljs-keyword">func</span>(s <span class="hljs-type">string</span>)</span></span>) <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(s <span class="hljs-type">string</span>)</span></span> &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(s <span class="hljs-type">string</span>)</span></span> &#123;<br>        fmt.Println(<span class="hljs-string">&quot;Started&quot;</span>)<br>        f(s)<br>        fmt.Println(<span class="hljs-string">&quot;Done&quot;</span>)<br>    &#125;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">Hello</span><span class="hljs-params">(s <span class="hljs-type">string</span>)</span></span> &#123;<br>    fmt.Println(s)<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>    decorator(Hello)(<span class="hljs-string">&quot;Hello, World!&quot;</span>)<br>&#125;<br><br></code></pre></td></tr></table></figure>
<p>可以看到，我们动用了一个高阶函数 <code>decorator()</code>，在调用的时候，先把 <code>Hello()</code> 函数传进去，然后其返回一个匿名函数。这个匿名函数中除了运行了自己的代码，也调用了被传入的 <code>Hello()</code> 函数。</p>
<p>这个玩法和Python的异曲同工，只不过，Go并不支持像Python那样的@decorator语法糖。所以，在调用上有些难看。当然，如果要想让代码容易读一些，你可以这样：</p>
<figure class="highlight isbl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs isbl"><span class="hljs-variable">hello</span> := <span class="hljs-function"><span class="hljs-title">decorator</span>(<span class="hljs-variable">Hello</span>)</span><br><span class="hljs-function"><span class="hljs-title">hello</span>(<span class="hljs-string">&quot;Hello&quot;</span>)</span><br><br></code></pre></td></tr></table></figure>
<p>我们再来看一个为函数log消耗时间的例子：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> SumFunc <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(<span class="hljs-type">int64</span>, <span class="hljs-type">int64</span>)</span></span> <span class="hljs-type">int64</span><br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">getFunctionName</span><span class="hljs-params">(i <span class="hljs-keyword">interface</span>&#123;&#125;)</span></span> <span class="hljs-type">string</span> &#123;<br>    <span class="hljs-keyword">return</span> runtime.FuncForPC(reflect.ValueOf(i).Pointer()).Name()<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">timedSumFunc</span><span class="hljs-params">(f SumFunc)</span></span> SumFunc &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(start, end <span class="hljs-type">int64</span>)</span></span> <span class="hljs-type">int64</span> &#123;<br>        <span class="hljs-keyword">defer</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(t time.Time)</span></span> &#123;<br>            fmt.Printf(<span class="hljs-string">&quot;--- Time Elapsed (%s): %v ---\n&quot;</span>,<br>                getFunctionName(f), time.Since(t))<br>        &#125;(time.Now())<br>        <span class="hljs-keyword">return</span> f(start, end)<br>    &#125;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">Sum1</span><span class="hljs-params">(start, end <span class="hljs-type">int64</span>)</span></span> <span class="hljs-type">int64</span> &#123;<br>    <span class="hljs-keyword">var</span> sum <span class="hljs-type">int64</span><br>    sum = <span class="hljs-number">0</span><br>    <span class="hljs-keyword">if</span> start &gt; end &#123;<br>        start, end = end, start<br>    &#125;<br>    <span class="hljs-keyword">for</span> i := start; i &lt;= end; i++ &#123;<br>        sum += i<br>    &#125;<br>    <span class="hljs-keyword">return</span> sum<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">Sum2</span><span class="hljs-params">(start, end <span class="hljs-type">int64</span>)</span></span> <span class="hljs-type">int64</span> &#123;<br>    <span class="hljs-keyword">if</span> start &gt; end &#123;<br>        start, end = end, start<br>    &#125;<br>    <span class="hljs-keyword">return</span> (end - start + <span class="hljs-number">1</span>) * (end + start) / <span class="hljs-number">2</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br><br>    sum1 := timedSumFunc(Sum1)<br>    sum2 := timedSumFunc(Sum2)<br><br>    fmt.Printf(<span class="hljs-string">&quot;%d, %d\n&quot;</span>, sum1(<span class="hljs-number">-10000</span>, <span class="hljs-number">10000000</span>), sum2(<span class="hljs-number">-10000</span>, <span class="hljs-number">10000000</span>))<br>&#125;<br><br></code></pre></td></tr></table></figure>
<p>关于上面的代码：</p>
<ul>
<li><p>有两个 Sum 函数， <code>Sum1()</code> 函数就是简单地做个循环， <code>Sum2()</code> 函数动用了数据公式。（注意： <code>start</code> 和 <code>end</code> 有可能有负数的情况。）</p>
</li>
<li><p>代码中使用了Go语言的反射机制来获取函数名。</p>
</li>
<li><p>修饰器函数是 <code>timedSumFunc()</code>。</p>
</li>
</ul>
<p>再来看一个 HTTP 路由的例子：</p>
<figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><code class="hljs scss">func <span class="hljs-built_in">WithServerHeader</span>(h http.HandlerFunc) http<span class="hljs-selector-class">.HandlerFunc</span> &#123;<br>    return <span class="hljs-built_in">func</span>(w http.ResponseWriter, r *http.Request) &#123;<br>        log<span class="hljs-selector-class">.Println</span>(&quot;---&gt;WithServerHeader()&quot;)<br>        w<span class="hljs-selector-class">.Header</span>()<span class="hljs-selector-class">.Set</span>(&quot;Server&quot;, &quot;HelloServer v0.<span class="hljs-number">0.1</span>&quot;)<br>        <span class="hljs-built_in">h</span>(w, r)<br>    &#125;<br>&#125;<br><br>func <span class="hljs-built_in">WithAuthCookie</span>(h http.HandlerFunc) http<span class="hljs-selector-class">.HandlerFunc</span> &#123;<br>    return <span class="hljs-built_in">func</span>(w http.ResponseWriter, r *http.Request) &#123;<br>        log<span class="hljs-selector-class">.Println</span>(&quot;---&gt;WithAuthCookie()&quot;)<br>        cookie := &amp;http.Cookie&#123;Name: <span class="hljs-string">&quot;Auth&quot;</span>, Value: <span class="hljs-string">&quot;Pass&quot;</span>, Path: <span class="hljs-string">&quot;/&quot;</span>&#125;<br>        http<span class="hljs-selector-class">.SetCookie</span>(w, cookie)<br>        <span class="hljs-built_in">h</span>(w, r)<br>    &#125;<br>&#125;<br><br>func <span class="hljs-built_in">WithBasicAuth</span>(h http.HandlerFunc) http<span class="hljs-selector-class">.HandlerFunc</span> &#123;<br>    return <span class="hljs-built_in">func</span>(w http.ResponseWriter, r *http.Request) &#123;<br>        log<span class="hljs-selector-class">.Println</span>(&quot;---&gt;WithBasicAuth()&quot;)<br>        cookie, err := r.Cookie(<span class="hljs-string">&quot;Auth&quot;</span>)<br>        if err != nil || cookie.Value != <span class="hljs-string">&quot;Pass&quot;</span> &#123;<br>            w<span class="hljs-selector-class">.WriteHeader</span>(http.StatusForbidden)<br>            return<br>        &#125;<br>        <span class="hljs-built_in">h</span>(w, r)<br>    &#125;<br>&#125;<br><br>func <span class="hljs-built_in">WithDebugLog</span>(h http.HandlerFunc) http<span class="hljs-selector-class">.HandlerFunc</span> &#123;<br>    return <span class="hljs-built_in">func</span>(w http.ResponseWriter, r *http.Request) &#123;<br>        log<span class="hljs-selector-class">.Println</span>(&quot;---&gt;WithDebugLog&quot;)<br>        r<span class="hljs-selector-class">.ParseForm</span>()<br>        log<span class="hljs-selector-class">.Println</span>(r.Form)<br>        log<span class="hljs-selector-class">.Println</span>(&quot;path&quot;, r.URL.Path)<br>        log<span class="hljs-selector-class">.Println</span>(&quot;scheme&quot;, r.URL.Scheme)<br>        log<span class="hljs-selector-class">.Println</span>(r.Form[&quot;url_long&quot;])<br>        for k, v := range r.Form &#123;<br>            log<span class="hljs-selector-class">.Println</span>(&quot;key:&quot;, k)<br>            log<span class="hljs-selector-class">.Println</span>(&quot;val:&quot;, strings.Join(v, &quot;&quot;))<br>        &#125;<br>        <span class="hljs-built_in">h</span>(w, r)<br>    &#125;<br>&#125;<br>func <span class="hljs-built_in">hello</span>(w http.ResponseWriter, r *http.Request) &#123;<br>    log<span class="hljs-selector-class">.Printf</span>(&quot;Received Request %s from %s\n&quot;, r.URL.Path, r.RemoteAddr)<br>    fmt<span class="hljs-selector-class">.Fprintf</span>(w, &quot;Hello, World! &quot;+r.URL.Path)<br>&#125;<br><br></code></pre></td></tr></table></figure>
<p>上面的代码中，我们写了多个函数。有写HTTP响应头的，有写认证Cookie的，有检查认证Cookie的，有打日志的……在使用过程中，我们可以把其嵌套起来使用，在修饰过的函数上继续修饰，这样就可以拼装出更复杂的功能。</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs stylus">func <span class="hljs-selector-tag">main</span>() &#123;<br>    http<span class="hljs-selector-class">.HandleFunc</span>(<span class="hljs-string">&quot;/v1/hello&quot;</span>, <span class="hljs-built_in">WithServerHeader</span>(<span class="hljs-built_in">WithAuthCookie</span>(hello)))<br>    http<span class="hljs-selector-class">.HandleFunc</span>(<span class="hljs-string">&quot;/v2/hello&quot;</span>, <span class="hljs-built_in">WithServerHeader</span>(<span class="hljs-built_in">WithBasicAuth</span>(hello)))<br>    http<span class="hljs-selector-class">.HandleFunc</span>(<span class="hljs-string">&quot;/v3/hello&quot;</span>, <span class="hljs-built_in">WithServerHeader</span>(<span class="hljs-built_in">WithBasicAuth</span>(<span class="hljs-built_in">WithDebugLog</span>(hello))))<br>    err := http<span class="hljs-selector-class">.ListenAndServe</span>(<span class="hljs-string">&quot;:8080&quot;</span>, nil)<br>    <span class="hljs-keyword">if</span> err != nil &#123;<br>        log<span class="hljs-selector-class">.Fatal</span>(<span class="hljs-string">&quot;ListenAndServe: &quot;</span>, err)<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>
<p>当然，如果一层套一层不好看的话，我们可以使用pipeline的玩法，需要先写一个工具函数——用来遍历并调用各个decorator：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> HttpHandlerDecorator <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(http.HandlerFunc)</span></span> http.HandlerFunc<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">Handler</span><span class="hljs-params">(h http.HandlerFunc, decors ...HttpHandlerDecorator)</span></span> http.HandlerFunc &#123;<br>    <span class="hljs-keyword">for</span> i := <span class="hljs-keyword">range</span> decors &#123;<br>        d := decors[<span class="hljs-built_in">len</span>(decors)<span class="hljs-number">-1</span>-i] <span class="hljs-comment">// iterate in reverse</span><br>        h = d(h)<br>    &#125;<br>    <span class="hljs-keyword">return</span> h<br>&#125;<br><br></code></pre></td></tr></table></figure>
<p>然后，我们就可以像下面这样使用了。</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs stylus">http<span class="hljs-selector-class">.HandleFunc</span>(<span class="hljs-string">&quot;/v4/hello&quot;</span>, <span class="hljs-built_in">Handler</span>(hello,<br>                WithServerHeader, WithBasicAuth, WithDebugLog))<br><br></code></pre></td></tr></table></figure>
<p>这样的代码是不是更易读了一些？pipeline的功能也就出来了。</p>
<p>不过，对于Go的修饰器模式，还有一个小问题——好像无法做到泛型，就像上面那个计算时间的函数一样，它的代码耦合了需要被修饰的函数的接口类型，无法做到非常通用。如果这个事解决不了，那么，这个修饰器模式还是有点不好用的。</p>
<p>因为Go语言不像Python和Java，Python是动态语言，而Java有语言虚拟机，所以它们可以干许多比较变态的事儿，然而Go语言是一个静态的语言，这意味着其类型需要在编译时就要搞定，否则无法编译。不过，Go语言支持的最大的泛型是interface{}，还有比较简单的Reflection机制，在上面做做文章，应该还是可以搞定的。</p>
<p>废话不说，下面是我用Reflection机制写的一个比较通用的修饰器（为了便于阅读，我删除了出错判断代码）。</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs stylus">func <span class="hljs-built_in">Decorator</span>(decoPtr, fn interface&#123;&#125;) (err error) &#123;<br>    <span class="hljs-selector-tag">var</span> decoratedFunc, targetFunc reflect<span class="hljs-selector-class">.Value</span><br><br>    decoratedFunc = reflect<span class="hljs-selector-class">.ValueOf</span>(decoPtr)<span class="hljs-selector-class">.Elem</span>()<br>    targetFunc = reflect<span class="hljs-selector-class">.ValueOf</span>(fn)<br><br>    v := reflect<span class="hljs-selector-class">.MakeFunc</span>(targetFunc<span class="hljs-selector-class">.Type</span>(),<br>        <span class="hljs-built_in">func</span>(<span class="hljs-keyword">in</span> <span class="hljs-selector-attr">[]</span>reflect.Value) (out <span class="hljs-selector-attr">[]</span>reflect.Value) &#123;<br>            fmt<span class="hljs-selector-class">.Println</span>(<span class="hljs-string">&quot;before&quot;</span>)<br>            out = targetFunc<span class="hljs-selector-class">.Call</span>(<span class="hljs-keyword">in</span>)<br>            fmt<span class="hljs-selector-class">.Println</span>(<span class="hljs-string">&quot;after&quot;</span>)<br>            return<br>        &#125;)<br><br>    decoratedFunc<span class="hljs-selector-class">.Set</span>(v)<br>    return<br>&#125;<br><br></code></pre></td></tr></table></figure>
<p>上面的代码动用了 <code>reflect.MakeFunc()</code> 函数制作出了一个新的函数，其中的 <code>targetFunc.Call(in)</code> 调用了被修饰的函数。关于Go语言的反射机制，推荐官方文章——《 <a target="_blank" rel="noopener" href="https://blog.golang.org/laws-of-reflection">The Laws of Reflection</a>》，在这里我不多说了。</p>
<p>上面这个 <code>Decorator()</code> 需要两个参数：</p>
<ul>
<li>第一个是出参 <code>decoPtr</code> ，就是完成修饰后的函数。</li>
<li>第二个是入参 <code>fn</code> ，就是需要修饰的函数。</li>
</ul>
<p>这样写是不是有些二？的确是的。不过，这是我个人在Go语言里所能写出来的最好的代码了。如果你知道更优雅的写法，请你一定告诉我！</p>
<p>好的，让我们来看一下使用效果。首先，假设我们有两个需要修饰的函数：</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs stylus">func <span class="hljs-built_in">foo</span>(<span class="hljs-selector-tag">a</span>, <span class="hljs-selector-tag">b</span>, c int) int &#123;<br>    fmt<span class="hljs-selector-class">.Printf</span>(<span class="hljs-string">&quot;%d, %d, %d \n&quot;</span>, <span class="hljs-selector-tag">a</span>, <span class="hljs-selector-tag">b</span>, c)<br>    return <span class="hljs-selector-tag">a</span> + <span class="hljs-selector-tag">b</span> + c<br>&#125;<br><br>func <span class="hljs-built_in">bar</span>(<span class="hljs-selector-tag">a</span>, <span class="hljs-selector-tag">b</span> string) string &#123;<br>    fmt<span class="hljs-selector-class">.Printf</span>(<span class="hljs-string">&quot;%s, %s \n&quot;</span>, <span class="hljs-selector-tag">a</span>, b)<br>    return <span class="hljs-selector-tag">a</span> + <span class="hljs-selector-tag">b</span><br>&#125;<br><br></code></pre></td></tr></table></figure>
<p>然后，我们可以这样做：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> MyFoo <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(<span class="hljs-type">int</span>, <span class="hljs-type">int</span>, <span class="hljs-type">int</span>)</span></span> <span class="hljs-type">int</span><br><span class="hljs-keyword">var</span> myfoo MyFoo<br>Decorator(&amp;myfoo, foo)<br>myfoo(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>)<br><br></code></pre></td></tr></table></figure>
<p>你会发现，使用 <code>Decorator()</code> 时，还需要先声明一个函数签名，感觉好傻啊。一点都不泛型，不是吗？谁叫这是有类型的静态编译的语言呢？</p>
<p>嗯。如果你不想声明函数签名，那么也可以这样：</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs stylus">mybar := bar<br><span class="hljs-function"><span class="hljs-title">Decorator</span><span class="hljs-params">(&amp;mybar, bar)</span></span><br><span class="hljs-function"><span class="hljs-title">mybar</span><span class="hljs-params">(<span class="hljs-string">&quot;hello,&quot;</span>, <span class="hljs-string">&quot;world!&quot;</span>)</span></span><br><br></code></pre></td></tr></table></figure>
<p>好吧，看上去不是那么得漂亮，但是it does work。看样子Go语言目前本身的特性无法做成像Java或Python那样，对此，我们只能多求Go语言多放糖了！</p>
<h1 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h1><p>好了，讲了那么多的例子，看了那么多的代码，我估计你可能有点晕，让我们来做个小结吧。</p>
<p>通过上面Python和Go修饰器的例子，我们可以看到，所谓的修饰器模式其实是在做下面的几件事。</p>
<ul>
<li><p>表面上看，修饰器模式就是扩展现有的一个函数的功能，让它可以干一些其他的事，或是在现有的函数功能上再附加上一些别的功能。</p>
</li>
<li><p>除了我们可以感受到 <strong>函数式编程</strong> 下的代码扩展能力，我们还能感受到函数的互相和随意拼装带来的好处。</p>
</li>
<li><p>但是深入看一下，我们不难发现，Decorator这个函数其实是可以修饰几乎所有的函数的。于是，这种可以通用于其它函数的编程方式，可以很容易地将一些非业务功能的、属于控制类型的代码给抽象出来（所谓的控制类型的代码就是像for-loop，或是打日志，或是函数路由，或是求函数运行时间之类的非业务功能性的代码）。</p>
</li>
</ul>
<p>以下是《编程范式游记》系列文章的目录，方便你了解这一系列内容的全貌。</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://time.geekbang.org/column/article/301">01 | 编程范式游记：起源</a></li>
<li><a target="_blank" rel="noopener" href="https://time.geekbang.org/column/article/303">02 | 编程范式游记：泛型编程</a></li>
<li><a target="_blank" rel="noopener" href="https://time.geekbang.org/column/article/2017">03 | 编程范式游记：类型系统和泛型的本质</a></li>
<li><a target="_blank" rel="noopener" href="https://time.geekbang.org/column/article/2711">04 | 编程范式游记：函数式编程</a></li>
<li><a target="_blank" rel="noopener" href="https://time.geekbang.org/column/article/2723">05 | 编程范式游记：修饰器模式</a></li>
<li><a target="_blank" rel="noopener" href="https://time.geekbang.org/column/article/2729">06 | 编程范式游记：面向对象编程</a></li>
<li><a target="_blank" rel="noopener" href="https://time.geekbang.org/column/article/2741">07 | 编程范式游记：基于原型的编程范式</a></li>
<li><a target="_blank" rel="noopener" href="https://time.geekbang.org/column/article/2748">08 | 编程范式游记：Go 语言的委托模式</a></li>
<li><a target="_blank" rel="noopener" href="https://time.geekbang.org/column/article/2751">09 | 编程范式游记：编程的本质</a></li>
<li><a target="_blank" rel="noopener" href="https://time.geekbang.org/column/article/2752">10 | 编程范式游记：逻辑编程范式</a></li>
<li><a target="_blank" rel="noopener" href="https://time.geekbang.org/column/article/2754">11 | 编程范式游记：程序世界里的编程范式</a></li>
</ul>

                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div></div>
      <div>http://example.com/2023/05/16/34-编程范式游记（5）-修饰器模式/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>Author</div>
          <div>WYX </div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>Posted on</div>
          <div>May 16, 2023</div>
        </div>
      
      
      <div class="license-meta-item">
        <div>Licensed under</div>
        <div>
          
            
            
              <a target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
              <span class="hint--top hint--rounded" aria-label="BY - Attribution">
                <i class="iconfont icon-by"></i>
              </span>
              </a>
            
          
        </div>
      </div>
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2023/05/16/35-%E7%BC%96%E7%A8%8B%E8%8C%83%E5%BC%8F%E6%B8%B8%E8%AE%B0%EF%BC%886%EF%BC%89-%E9%9D%A2%E5%90%91%E5%AF%B9%E8%B1%A1%E7%BC%96%E7%A8%8B/" title="">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile"></span>
                        <span class="visible-mobile">Previous</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2023/05/16/33-%E7%BC%96%E7%A8%8B%E8%8C%83%E5%BC%8F%E6%B8%B8%E8%AE%B0%EF%BC%884%EF%BC%89-%E5%87%BD%E6%95%B0%E5%BC%8F%E7%BC%96%E7%A8%8B/" title="">
                        <span class="hidden-mobile"></span>
                        <span class="visible-mobile">Next</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;Table of Contents</p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  


  
  









    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">Search</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">Keyword</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a>
    </div>
  
  
  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.0/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.18.2/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      headingSelector : CONFIG.toc.headingSelector || 'h1,h2,h3,h4,h5,h6',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      collapseDepth   : CONFIG.toc.collapseDepth || 0,
      scrollSmooth    : true,
      headingsOffset  : -boardTop
    });
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.10/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  
      <script>
        if (!window.MathJax) {
          window.MathJax = {
            tex    : {
              inlineMath: { '[+]': [['$', '$']] }
            },
            loader : {
              load: ['ui/lazy']
            },
            options: {
              renderActions: {
                insertedScript: [200, () => {
                  document.querySelectorAll('mjx-container').forEach(node => {
                    let target = node.parentNode;
                    if (target.nodeName.toLowerCase() === 'li') {
                      target.parentNode.classList.add('has-jax');
                    }
                  });
                }, '', false]
              }
            }
          };
        } else {
          MathJax.startup.document.state(0);
          MathJax.texReset();
          MathJax.typeset();
          MathJax.typesetPromise();
        }
      </script>
    

  <script  src="https://lib.baomitu.com/mathjax/3.2.1/es5/tex-mml-chtml.js" ></script>

  <script  src="/js/local-search.js" ></script>





<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">Blog works best with JavaScript enabled</div>
  </noscript>
</body>
</html>
