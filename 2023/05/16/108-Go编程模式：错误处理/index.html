

<!DOCTYPE html>
<html lang="en" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/fluid.png">
  <link rel="icon" href="/img/fluid.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="WYX ">
  <meta name="keywords" content="">
  
    <meta name="description" content="108 | Go 编程模式：错误处理你好，我是陈皓，网名左耳朵耗子。 错误处理一直是编程必须要面对的问题。错误处理如果做得好的话，代码的稳定性会很好。不同的语言有不同的错误处理的方式。Go语言也一样，这节课，我们来讨论一下Go语言的错误出处，尤其是那令人抓狂的 if err !&#x3D; nil 。 在正式讨论“Go代码里满屏的 if err !&#x3D; nil 怎么办”这件事儿之前，我想先说一说编程中的错误处">
<meta property="og:type" content="article">
<meta property="og:title" content="WYX同学的Blog">
<meta property="og:url" content="http://example.com/2023/05/16/108-Go%E7%BC%96%E7%A8%8B%E6%A8%A1%E5%BC%8F%EF%BC%9A%E9%94%99%E8%AF%AF%E5%A4%84%E7%90%86/index.html">
<meta property="og:site_name" content="WYX同学的Blog">
<meta property="og:description" content="108 | Go 编程模式：错误处理你好，我是陈皓，网名左耳朵耗子。 错误处理一直是编程必须要面对的问题。错误处理如果做得好的话，代码的稳定性会很好。不同的语言有不同的错误处理的方式。Go语言也一样，这节课，我们来讨论一下Go语言的错误出处，尤其是那令人抓狂的 if err !&#x3D; nil 。 在正式讨论“Go代码里满屏的 if err !&#x3D; nil 怎么办”这件事儿之前，我想先说一说编程中的错误处">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2023-05-16T07:44:34.257Z">
<meta property="article:modified_time" content="2023-05-16T07:44:34.257Z">
<meta property="article:author" content="WYX ">
<meta name="twitter:card" content="summary_large_image">
  
  
  
  <title>WYX同学的Blog</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  




  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"example.com","root":"/","version":"1.9.2","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":false,"follow_dnt":true,"baidu":null,"google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false}},"search_path":"/local-search.xml"};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  


  
<!-- hexo injector head_end start -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css">
<!-- hexo injector head_end end --><meta name="generator" content="Hexo 6.2.0"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>WYX&#39;s Blog</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                Home
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                Archives
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                Categories
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                Tags
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                About
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              &nbsp;<i class="iconfont icon-search"></i>&nbsp;
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">&nbsp;<i
                class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/img/default.png') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text=""></span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2023-05-16 15:44" pubdate>
          May 16, 2023 pm
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          7.5k words
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          63 mins
        
      </span>
    

    
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none"></h1>
            
            
              <div class="markdown-body">
                
                <h1 id="108-Go-编程模式：错误处理"><a href="#108-Go-编程模式：错误处理" class="headerlink" title="108 | Go 编程模式：错误处理"></a>108 | Go 编程模式：错误处理</h1><p>你好，我是陈皓，网名左耳朵耗子。</p>
<p>错误处理一直是编程必须要面对的问题。错误处理如果做得好的话，代码的稳定性会很好。不同的语言有不同的错误处理的方式。Go语言也一样，这节课，我们来讨论一下Go语言的错误出处，尤其是那令人抓狂的 <code>if err != nil</code> 。</p>
<p>在正式讨论“Go代码里满屏的 <code>if err != nil</code> 怎么办”这件事儿之前，我想先说一说编程中的错误处理。</p>
<h2 id="C语言的错误检查"><a href="#C语言的错误检查" class="headerlink" title="C语言的错误检查"></a>C语言的错误检查</h2><p>首先，我们知道，处理错误最直接的方式是通过错误码，这也是传统的方式，在过程式语言中通常都是用这样的方式处理错误的。比如 C 语言，基本上来说，其通过函数的返回值标识是否有错，然后通过全局的 <code>errno</code> 变量加一个 <code>errstr</code> 的数组来告诉你为什么出错。</p>
<p>为什么是这样的设计呢？道理很简单，除了可以共用一些错误，更重要的是这其实是一种妥协，比如： <code>read()</code>、 <code>write()</code>、 <code>open()</code> 这些函数的返回值其实是返回有业务逻辑的值，也就是说，这些函数的返回值有两种语义：</p>
<ol>
<li>一种是成功的值，比如 <code>open()</code> 返回的文件句柄指针 <code>FILE*</code> ；</li>
<li>另一种是错误 <code>NULL</code>。这会导致调用者并不知道是什么原因出错了，需要去检查 <code>errno</code> 以获得出错的原因，从而正确地处理错误。</li>
</ol>
<p>一般而言，这样的错误处理方式在大多数情况下是没什么问题的，不过也有例外的情况，我们来看一下下面这个 C 语言的函数：</p>
<figure class="highlight axapta"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs axapta"><span class="hljs-built_in">int</span> atoi(<span class="hljs-keyword">const</span> <span class="hljs-built_in">char</span> *<span class="hljs-built_in">str</span>)<br><br></code></pre></td></tr></table></figure>
<p>这个函数是把一个字符串转成整型。但是问题来了，如果一个要转的字符串是非法的（不是数字的格式），如 “ABC” 或者整型溢出了，那么这个函数应该返回什么呢？出错返回，返回什么数都不合理，因为这会和正常的结果混淆在一起。比如，如果返回 <code>0</code>，就会和正常的对 “0” 字符的返回值完全混淆在一起，这样就无法判断出错的情况了。你可能会说，是不是要检查一下 <code>errno</code> 呢？按道理说应该是要去检查的，但是，我们在 C99 的规格说明书中可以看到这样的描述：</p>
<blockquote>
<p>_7.20.1The functions atof, atoi, atol, and atoll need not affect the value of the integer expression errno on an error. If the value of the result cannot be represented, the behavior is undeﬁned._</p>
</blockquote>
<p>像 <code>atoi()</code>、 <code>atof()</code>、 <code>atol()</code> 或 <code>atoll()</code> 这样的函数，是不会设置 <code>errno</code> 的，而且，如果结果无法计算的话，行为是undefined。所以，后来，libc 又给出了一个新的函数 <code>strtol()</code>，这个函数在出错的时候会设置全局变量 <code>errno</code> ：</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs awk">long val = strtol(in_str, &amp;endptr, <span class="hljs-number">10</span>);  <span class="hljs-regexp">//</span><span class="hljs-number">10</span>的意思是<span class="hljs-number">10</span>进制<br><br><span class="hljs-regexp">//</span>如果无法转换<br><span class="hljs-keyword">if</span> (endptr == str) &#123;<br>    fprintf(stderr, <span class="hljs-string">&quot;No digits were found\n&quot;</span>);<br>    <span class="hljs-keyword">exit</span>(EXIT_FAILURE);<br>&#125;<br><br><span class="hljs-regexp">//</span>如果整型溢出了<br><span class="hljs-keyword">if</span> ((errno == ERANGE &amp;&amp; (val == LONG_MAX || val == LONG_MIN)) &#123;<br>    fprintf(stderr, <span class="hljs-string">&quot;ERROR: number out of range for LONG\n&quot;</span>);<br>    <span class="hljs-keyword">exit</span>(EXIT_FAILURE);<br> &#125;<br><br><span class="hljs-regexp">//</span>如果是其它错误<br><span class="hljs-keyword">if</span> (errno != <span class="hljs-number">0</span> &amp;&amp; val == <span class="hljs-number">0</span>) &#123;<br>    perror(<span class="hljs-string">&quot;strtol&quot;</span>);<br>    <span class="hljs-keyword">exit</span>(EXIT_FAILURE);<br>&#125;<br><br></code></pre></td></tr></table></figure>
<p>虽然， <code>strtol()</code> 函数解决了 <code>atoi()</code> 函数的问题，但是我们还是能感觉到不是很舒服，也不是很自然。</p>
<p>因为这种用返回值 + errno 的错误检查方式会有一些问题：</p>
<ul>
<li>程序员一不小心就会忘记检查返回值，从而造成代码的 Bug；</li>
<li>函数接口非常不纯洁，正常值和错误值混淆在一起，导致语义有问题。</li>
</ul>
<p>所以，后来有一些类库就开始区分这样的事情。比如，Windows 的系统调用开始使用 <code>HRESULT</code> 的返回来统一错误的返回值，这样可以明确函数调用时的返回值是成功还是错误。但这样一来，函数的 input 和 output 只能通过函数的参数来完成，于是就出现了所谓的“入参”和“出参”这样的区别。</p>
<p>然而，这又使得函数接入中参数的语义变得很复杂，一些参数是入参，一些参数是出参，函数接口变得复杂了一些。而且，依然没有解决函数的成功或失败可以被人为忽略的问题。</p>
<h2 id="Java的错误处理"><a href="#Java的错误处理" class="headerlink" title="Java的错误处理"></a>Java的错误处理</h2><p>Java语言使用 <code>try-catch-finally</code> 通过使用异常的方式来处理错误，其实，这比起C语言的错误处理进了一大步，使用抛异常和抓异常的方式可以让我们的代码有这样一些好处。</p>
<ul>
<li>函数接口在 input（参数）和 output（返回值）以及错误处理的语义是比较清楚的。</li>
<li>正常逻辑的代码可以跟错误处理和资源清理的代码分开，提高了代码的可读性。</li>
<li>异常不能被忽略（如果要忽略也需要 catch 住，这是显式忽略）。</li>
<li>在面向对象的语言中（如 Java），异常是个对象，所以，可以实现多态式的 catch。</li>
<li>与状态返回码相比，异常捕捉有一个显著的好处，那就是函数可以嵌套调用，或是链式调用，比如：</li>
</ul>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs reasonml"><span class="hljs-built_in">int</span> x = add(a, div(b,c));<br>Pizza p = <span class="hljs-constructor">PizzaBuilder()</span>.<span class="hljs-constructor">SetSize(<span class="hljs-params">sz</span>)</span>.<span class="hljs-constructor">SetPrice(<span class="hljs-params">p</span>)</span>...;<br><br></code></pre></td></tr></table></figure>
<h2 id="Go语言的错误处理"><a href="#Go语言的错误处理" class="headerlink" title="Go语言的错误处理"></a>Go语言的错误处理</h2><p>Go 语言的函数支持多返回值，所以，可以在返回接口把业务语义（业务返回值）和控制语义（出错返回值）区分开。Go 语言的很多函数都会返回 result、err 两个值，于是就有这样几点：</p>
<ul>
<li>参数上基本上就是入参，而返回接口把结果和错误分离，这样使得函数的接口语义清晰；</li>
<li>而且，Go 语言中的错误参数如果要忽略，需要显式地忽略，用 _ 这样的变量来忽略；</li>
<li>另外，因为返回的 <code>error</code> 是个接口（其中只有一个方法 <code>Error()</code>，返回一个 <code>string</code> ），所以你可以扩展自定义的错误处理。</li>
</ul>
<p>另外，如果一个函数返回了多个不同类型的 <code>error</code>，你也可以使用下面这样的方式：</p>
<figure class="highlight lasso"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs lasso"><span class="hljs-keyword">if</span> err != nil &#123;<br>  switch err.(<span class="hljs-keyword">type</span>) &#123;<br>    <span class="hljs-keyword">case</span> *json.SyntaxError:<br>      <span class="hljs-params">...</span><br>    <span class="hljs-keyword">case</span> *ZeroDivisionError:<br>      <span class="hljs-params">...</span><br>    <span class="hljs-keyword">case</span> *NullPointerError:<br>      <span class="hljs-params">...</span><br>    default:<br>      <span class="hljs-params">...</span><br>  &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>
<p>我们可以看到， <strong>Go语言的错误处理的方式，本质上是返回值检查，但是它也兼顾了异常的一些好处——对错误的扩展</strong>。</p>
<h2 id="资源清理"><a href="#资源清理" class="headerlink" title="资源清理"></a>资源清理</h2><p>出错后是需要做资源清理的，不同的编程语言有不同的资源清理的编程模式。</p>
<ul>
<li>C语言：使用的是 <code>goto fail;</code> 的方式到一个集中的地方进行清理（给你推荐一篇有意思的文章《 <a target="_blank" rel="noopener" href="https://coolshell.cn/articles/11112.html">由苹果的低级BUG想到的</a>》，你可以点击链接看一下）。</li>
<li>C++语言：一般来说使用 <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Resource_acquisition_is_initialization">RAII模式</a>，通过面向对象的代理模式，把需要清理的资源交给一个代理类，然后再析构函数来解决。</li>
<li>Java语言：可以在finally 语句块里进行清理。</li>
<li>Go语言：使用 <code>defer</code> 关键词进行清理。</li>
</ul>
<p>下面是一个Go语言的资源清理的示例：</p>
<figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs stata">func <span class="hljs-keyword">Close</span>(c io.Closer) &#123;<br>  <span class="hljs-keyword">err</span> := c.<span class="hljs-keyword">Close</span>()<br>  <span class="hljs-keyword">if</span> <span class="hljs-keyword">err</span> != nil &#123;<br>    <span class="hljs-keyword">log</span>.Fatal(<span class="hljs-keyword">err</span>)<br>  &#125;<br>&#125;<br><br>func main() &#123;<br>  r, <span class="hljs-keyword">err</span> := <span class="hljs-keyword">Open</span>(<span class="hljs-string">&quot;a&quot;</span>)<br>  <span class="hljs-keyword">if</span> <span class="hljs-keyword">err</span> != nil &#123;<br>    <span class="hljs-keyword">log</span>.Fatalf(<span class="hljs-string">&quot;error opening &#x27;a&#x27;\n&quot;</span>)<br>  &#125;<br>  defer <span class="hljs-keyword">Close</span>(r) <span class="hljs-comment">// 使用defer关键字在函数退出时关闭文件。</span><br><br>  r, <span class="hljs-keyword">err</span> = <span class="hljs-keyword">Open</span>(<span class="hljs-string">&quot;b&quot;</span>)<br>  <span class="hljs-keyword">if</span> <span class="hljs-keyword">err</span> != nil &#123;<br>    <span class="hljs-keyword">log</span>.Fatalf(<span class="hljs-string">&quot;error opening &#x27;b&#x27;\n&quot;</span>)<br>  &#125;<br>  defer <span class="hljs-keyword">Close</span>(r) <span class="hljs-comment">// 使用defer关键字在函数退出时关闭文件。</span><br>&#125;<br><br></code></pre></td></tr></table></figure>
<h2 id="Error-Check-Hell"><a href="#Error-Check-Hell" class="headerlink" title="Error Check Hell"></a>Error Check Hell</h2><p>好了，说到 Go 语言的 <code>if err !=nil</code> 的代码了，这样的代码的确是能让人写到吐。那么有没有什么好的方式呢？有的。我们先看一个令人崩溃的代码。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">parse</span><span class="hljs-params">(r io.Reader)</span></span> (*Point, <span class="hljs-type">error</span>) &#123;<br><br>    <span class="hljs-keyword">var</span> p Point<br><br>    <span class="hljs-keyword">if</span> err := binary.Read(r, binary.BigEndian, &amp;p.Longitude); err != <span class="hljs-literal">nil</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, err<br>    &#125;<br>    <span class="hljs-keyword">if</span> err := binary.Read(r, binary.BigEndian, &amp;p.Latitude); err != <span class="hljs-literal">nil</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, err<br>    &#125;<br>    <span class="hljs-keyword">if</span> err := binary.Read(r, binary.BigEndian, &amp;p.Distance); err != <span class="hljs-literal">nil</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, err<br>    &#125;<br>    <span class="hljs-keyword">if</span> err := binary.Read(r, binary.BigEndian, &amp;p.ElevationGain); err != <span class="hljs-literal">nil</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, err<br>    &#125;<br>    <span class="hljs-keyword">if</span> err := binary.Read(r, binary.BigEndian, &amp;p.ElevationLoss); err != <span class="hljs-literal">nil</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, err<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>
<p>要解决这个事，我们可以用函数式编程的方式，如下代码示例：</p>
<figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs stata">func <span class="hljs-keyword">parse</span>(r io.Reader) (*Point, <span class="hljs-keyword">error</span>) &#123;<br>    <span class="hljs-keyword">var</span> p Point<br>    <span class="hljs-keyword">var</span> <span class="hljs-keyword">err</span> <span class="hljs-keyword">error</span><br>    <span class="hljs-keyword">read</span> := func(data interface&#123;&#125;) &#123;<br>        <span class="hljs-keyword">if</span> <span class="hljs-keyword">err</span> != nil &#123;<br>            <span class="hljs-keyword">return</span><br>        &#125;<br>        <span class="hljs-keyword">err</span> = binary.<span class="hljs-keyword">Read</span>(r, binary.BigEndian, data)<br>    &#125;<br><br>    <span class="hljs-keyword">read</span>(&amp;p.Longitude)<br>    <span class="hljs-keyword">read</span>(&amp;p.Latitude)<br>    <span class="hljs-keyword">read</span>(&amp;p.Distance)<br>    <span class="hljs-keyword">read</span>(&amp;p.ElevationGain)<br>    <span class="hljs-keyword">read</span>(&amp;p.ElevationLoss)<br><br>    <span class="hljs-keyword">if</span> <span class="hljs-keyword">err</span> != nil &#123;<br>        <span class="hljs-keyword">return</span> &amp;p, <span class="hljs-keyword">err</span><br>    &#125;<br>    <span class="hljs-keyword">return</span> &amp;p, nil<br>&#125;<br><br></code></pre></td></tr></table></figure>
<p>从这段代码中，我们可以看到，我们通过使用Closure 的方式把相同的代码给抽出来重新定义一个函数，这样大量的 <code>if err!=nil</code> 处理得很干净了，但是会带来一个问题，那就是有一个 <code>err</code> 变量和一个内部的函数，感觉不是很干净。</p>
<p>那么，我们还能不能搞得更干净一点呢？我们从Go 语言的 <code>bufio.Scanner()</code> 中似乎可以学习到一些东西：</p>
<figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs stata">scanner := bufio.NewScanner(<span class="hljs-keyword">input</span>)<br><br><span class="hljs-keyword">for</span> scanner.Scan() &#123;<br>    <span class="hljs-keyword">token</span> := scanner.Text()<br>    <span class="hljs-comment">// process token</span><br>&#125;<br><br><span class="hljs-keyword">if</span> <span class="hljs-keyword">err</span> := scanner.<span class="hljs-keyword">Err</span>(); <span class="hljs-keyword">err</span> != nil &#123;<br>    <span class="hljs-comment">// process the error</span><br>&#125;<br><br></code></pre></td></tr></table></figure>
<p>可以看到， <code>scanner</code> 在操作底层的I/O的时候，那个for-loop中没有任何的 <code>if err !=nil</code> 的情况，退出循环后有一个 <code>scanner.Err()</code> 的检查，看来使用了结构体的方式。模仿它，就可以对我们的代码进行重构了。</p>
<p>首先，定义一个结构体和一个成员函数：</p>
<figure class="highlight haskell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs haskell"><span class="hljs-class"><span class="hljs-keyword">type</span> <span class="hljs-type">Reader</span> struct &#123;</span><br><span class="hljs-class">    <span class="hljs-title">r</span>   <span class="hljs-title">io</span>.<span class="hljs-type">Reader</span></span><br><span class="hljs-class">    <span class="hljs-title">err</span> <span class="hljs-title">error</span></span><br><span class="hljs-class">&#125;</span><br><br><span class="hljs-title">func</span> (r *<span class="hljs-type">Reader</span>) read(<span class="hljs-class"><span class="hljs-keyword">data</span> interface&#123;&#125;) &#123;</span><br><span class="hljs-class">    <span class="hljs-title">if</span> <span class="hljs-title">r</span>.<span class="hljs-title">err</span> == <span class="hljs-title">nil</span> &#123;</span><br><span class="hljs-class">        <span class="hljs-title">r</span>.<span class="hljs-title">err</span> = <span class="hljs-title">binary</span>.<span class="hljs-type">Read</span>(<span class="hljs-title">r</span>.<span class="hljs-title">r</span>, <span class="hljs-title">binary</span>.<span class="hljs-type">BigEndian</span>, <span class="hljs-title">data</span>)</span><br><span class="hljs-class">    &#125;</span><br>&#125;<br><br></code></pre></td></tr></table></figure>
<p>然后，我们的代码就可以变成下面这样：</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs stylus">func <span class="hljs-built_in">parse</span>(<span class="hljs-selector-tag">input</span> io.Reader) (*Point, error) &#123;<br>    <span class="hljs-selector-tag">var</span> <span class="hljs-selector-tag">p</span> Point<br>    r := Reader&#123;r: input&#125;<br><br>    r<span class="hljs-selector-class">.read</span>(&amp;<span class="hljs-selector-tag">p</span>.Longitude)<br>    r<span class="hljs-selector-class">.read</span>(&amp;<span class="hljs-selector-tag">p</span>.Latitude)<br>    r<span class="hljs-selector-class">.read</span>(&amp;<span class="hljs-selector-tag">p</span>.Distance)<br>    r<span class="hljs-selector-class">.read</span>(&amp;<span class="hljs-selector-tag">p</span>.ElevationGain)<br>    r<span class="hljs-selector-class">.read</span>(&amp;<span class="hljs-selector-tag">p</span>.ElevationLoss)<br><br>    <span class="hljs-keyword">if</span> r<span class="hljs-selector-class">.err</span> != nil &#123;<br>        return nil, r<span class="hljs-selector-class">.err</span><br>    &#125;<br><br>    return &amp;<span class="hljs-selector-tag">p</span>, nil<br>&#125;<br><br></code></pre></td></tr></table></figure>
<p>有了刚刚的这个技术，我们的“ <a target="_blank" rel="noopener" href="https://martinfowler.com/bliki/FluentInterface.html">流式接口 Fluent Interface</a>”也就很容易处理了。如下所示：</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><code class="hljs stylus">package <span class="hljs-selector-tag">main</span><br><br>import (<br>  <span class="hljs-string">&quot;bytes&quot;</span><br>  <span class="hljs-string">&quot;encoding/binary&quot;</span><br>  <span class="hljs-string">&quot;fmt&quot;</span><br>)<br><br><span class="hljs-comment">// 长度不够，少一个Weight</span><br><span class="hljs-selector-tag">var</span> <span class="hljs-selector-tag">b</span> = <span class="hljs-selector-attr">[]</span>byte &#123;<span class="hljs-number">0</span>x48, <span class="hljs-number">0</span>x61, <span class="hljs-number">0</span>x6f, <span class="hljs-number">0</span>x20, <span class="hljs-number">0</span>x43, <span class="hljs-number">0</span>x68, <span class="hljs-number">0</span>x65, <span class="hljs-number">0</span>x6e, <span class="hljs-number">0</span>x00, <span class="hljs-number">0</span>x00, <span class="hljs-number">0</span>x2c&#125;<br><span class="hljs-selector-tag">var</span> r = bytes<span class="hljs-selector-class">.NewReader</span>(b)<br><br>type Person struct &#123;<br>  Name <span class="hljs-selector-attr">[10]</span>byte<br>  Age uint8<br>  Weight uint8<br>  err error<br>&#125;<br>func (<span class="hljs-selector-tag">p</span> *Person) <span class="hljs-built_in">read</span>(data interface&#123;&#125;) &#123;<br>  <span class="hljs-keyword">if</span> <span class="hljs-selector-tag">p</span><span class="hljs-selector-class">.err</span> == nil &#123;<br>    <span class="hljs-selector-tag">p</span><span class="hljs-selector-class">.err</span> = binary<span class="hljs-selector-class">.Read</span>(r, binary<span class="hljs-selector-class">.BigEndian</span>, data)<br>  &#125;<br>&#125;<br><br>func (<span class="hljs-selector-tag">p</span> *Person) <span class="hljs-built_in">ReadName</span>() *Person &#123;<br>  <span class="hljs-selector-tag">p</span><span class="hljs-selector-class">.read</span>(&amp;<span class="hljs-selector-tag">p</span>.Name)<br>  return <span class="hljs-selector-tag">p</span><br>&#125;<br>func (<span class="hljs-selector-tag">p</span> *Person) <span class="hljs-built_in">ReadAge</span>() *Person &#123;<br>  <span class="hljs-selector-tag">p</span><span class="hljs-selector-class">.read</span>(&amp;<span class="hljs-selector-tag">p</span>.Age)<br>  return <span class="hljs-selector-tag">p</span><br>&#125;<br>func (<span class="hljs-selector-tag">p</span> *Person) <span class="hljs-built_in">ReadWeight</span>() *Person &#123;<br>  <span class="hljs-selector-tag">p</span><span class="hljs-selector-class">.read</span>(&amp;<span class="hljs-selector-tag">p</span>.Weight)<br>  return <span class="hljs-selector-tag">p</span><br>&#125;<br>func (<span class="hljs-selector-tag">p</span> *Person) <span class="hljs-built_in">Print</span>() *Person &#123;<br>  <span class="hljs-keyword">if</span> <span class="hljs-selector-tag">p</span><span class="hljs-selector-class">.err</span> == nil &#123;<br>    fmt<span class="hljs-selector-class">.Printf</span>(<span class="hljs-string">&quot;Name=%s, Age=%d, Weight=%d\n&quot;</span>,<span class="hljs-selector-tag">p</span><span class="hljs-selector-class">.Name</span>, <span class="hljs-selector-tag">p</span><span class="hljs-selector-class">.Age</span>, <span class="hljs-selector-tag">p</span>.Weight)<br>  &#125;<br>  return <span class="hljs-selector-tag">p</span><br>&#125;<br><br>func <span class="hljs-selector-tag">main</span>() &#123;<br>  <span class="hljs-selector-tag">p</span> := Person&#123;&#125;<br>  <span class="hljs-selector-tag">p</span><span class="hljs-selector-class">.ReadName</span>()<span class="hljs-selector-class">.ReadAge</span>()<span class="hljs-selector-class">.ReadWeight</span>()<span class="hljs-selector-class">.Print</span>()<br>  fmt<span class="hljs-selector-class">.Println</span>(<span class="hljs-selector-tag">p</span>.err)  <span class="hljs-comment">// EOF 错误</span><br>&#125;<br><br></code></pre></td></tr></table></figure>
<p>相信你应该看懂这个技巧了，不过，需要注意的是，它的使用场景是有局限的，也就只能在对于同一个业务对象的不断操作下可以简化错误处理，如果是多个业务对象，还是得需要各种 <code>if err != nil</code> 的方式。</p>
<h2 id="包装错误"><a href="#包装错误" class="headerlink" title="包装错误"></a>包装错误</h2><p>最后，多说一句，我们需要包装一下错误，而不是干巴巴地把 <code>err</code> 返回到上层，我们需要把一些执行的上下文加入。</p>
<p>通常来说，我们会使用 <code>fmt.Errorf()</code> 来完成这个事，比如：</p>
<figure class="highlight hsp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs hsp"><span class="hljs-keyword">if</span> <span class="hljs-keyword">err</span> != nil &#123;<br>   <span class="hljs-keyword">return</span> fmt.Errorf(<span class="hljs-string">&quot;something failed: %v&quot;</span>, <span class="hljs-keyword">err</span>)<br>&#125;<br><br></code></pre></td></tr></table></figure>
<p>另外，在Go语言的开发者中，更为普遍的做法是将错误包装在另一个错误中，同时保留原始内容：</p>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs reasonml"><span class="hljs-keyword">type</span> authorizationError <span class="hljs-keyword">struct</span> &#123;<br>    operation <span class="hljs-built_in">string</span><br>    err error   <span class="hljs-comment">// original error</span><br>&#125;<br><br>func (e *authorizationError) <span class="hljs-constructor">Error()</span> <span class="hljs-built_in">string</span> &#123;<br>    return fmt.<span class="hljs-constructor">Sprintf(<span class="hljs-string">&quot;authorization failed during %s: %v&quot;</span>, <span class="hljs-params">e</span>.<span class="hljs-params">operation</span>, <span class="hljs-params">e</span>.<span class="hljs-params">err</span>)</span><br>&#125;<br><br></code></pre></td></tr></table></figure>
<p>当然，更好的方式是通过一种标准的访问方法，这样，我们最好使用一个接口，比如 <code>causer</code> 接口中实现 <code>Cause()</code> 方法来暴露原始错误，以供进一步检查：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> causer <span class="hljs-keyword">interface</span> &#123;<br>    Cause() <span class="hljs-type">error</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(e *authorizationError)</span></span> Cause() <span class="hljs-type">error</span> &#123;<br>    <span class="hljs-keyword">return</span> e.err<br>&#125;<br><br></code></pre></td></tr></table></figure>
<p>这里有个好消息是，这样的代码不必再写了，有一个第三方的 <a target="_blank" rel="noopener" href="http://github.com/pkg/errors">错误库</a>，对于这个库，我无论到哪儿都能看到它的存在，所以，这个基本上来说就是事实上的标准了。代码示例如下：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">import</span> <span class="hljs-string">&quot;github.com/pkg/errors&quot;</span><br><br><span class="hljs-comment">//错误包装</span><br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>    <span class="hljs-keyword">return</span> errors.Wrap(err, <span class="hljs-string">&quot;read failed&quot;</span>)<br>&#125;<br><br><span class="hljs-comment">// Cause接口</span><br><span class="hljs-keyword">switch</span> err := errors.Cause(err).(<span class="hljs-keyword">type</span>) &#123;<br><span class="hljs-keyword">case</span> *MyError:<br>    <span class="hljs-comment">// handle specifically</span><br><span class="hljs-keyword">default</span>:<br>    <span class="hljs-comment">// unknown error</span><br>&#125;<br><br></code></pre></td></tr></table></figure>
<h2 id="参考文章"><a href="#参考文章" class="headerlink" title="参考文章"></a>参考文章</h2><ul>
<li><a target="_blank" rel="noopener" href="http://jxck.hatenablog.com/entry/golang-error-handling-lesson-by-rob-pike">Golang Error Handling lesson by Rob Pike</a></li>
<li><a target="_blank" rel="noopener" href="https://blog.golang.org/errors-are-values">Errors are values</a></li>
</ul>
<p>好了，这节课就到这里。如果你觉得今天的内容对你有所帮助，欢迎你帮我分享给更多人。</p>

                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div></div>
      <div>http://example.com/2023/05/16/108-Go编程模式：错误处理/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>Author</div>
          <div>WYX </div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>Posted on</div>
          <div>May 16, 2023</div>
        </div>
      
      
      <div class="license-meta-item">
        <div>Licensed under</div>
        <div>
          
            
            
              <a target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
              <span class="hint--top hint--rounded" aria-label="BY - Attribution">
                <i class="iconfont icon-by"></i>
              </span>
              </a>
            
          
        </div>
      </div>
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2023/05/16/109-Go%E7%BC%96%E7%A8%8B%E6%A8%A1%E5%BC%8F%EF%BC%9AFunctionalOptions/" title="">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile"></span>
                        <span class="visible-mobile">Previous</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2023/05/16/107-Go%E7%BC%96%E7%A8%8B%E6%A8%A1%E5%BC%8F%EF%BC%9A%E5%88%87%E7%89%87%E3%80%81%E6%8E%A5%E5%8F%A3%E3%80%81%E6%97%B6%E9%97%B4%E5%92%8C%E6%80%A7%E8%83%BD/" title="">
                        <span class="hidden-mobile"></span>
                        <span class="visible-mobile">Next</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;Table of Contents</p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  


  
  









    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">Search</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">Keyword</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a>
    </div>
  
  
  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.0/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.18.2/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      headingSelector : CONFIG.toc.headingSelector || 'h1,h2,h3,h4,h5,h6',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      collapseDepth   : CONFIG.toc.collapseDepth || 0,
      scrollSmooth    : true,
      headingsOffset  : -boardTop
    });
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.10/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  
      <script>
        if (!window.MathJax) {
          window.MathJax = {
            tex    : {
              inlineMath: { '[+]': [['$', '$']] }
            },
            loader : {
              load: ['ui/lazy']
            },
            options: {
              renderActions: {
                insertedScript: [200, () => {
                  document.querySelectorAll('mjx-container').forEach(node => {
                    let target = node.parentNode;
                    if (target.nodeName.toLowerCase() === 'li') {
                      target.parentNode.classList.add('has-jax');
                    }
                  });
                }, '', false]
              }
            }
          };
        } else {
          MathJax.startup.document.state(0);
          MathJax.texReset();
          MathJax.typeset();
          MathJax.typesetPromise();
        }
      </script>
    

  <script  src="https://lib.baomitu.com/mathjax/3.2.1/es5/tex-mml-chtml.js" ></script>

  <script  src="/js/local-search.js" ></script>





<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">Blog works best with JavaScript enabled</div>
  </noscript>
</body>
</html>
