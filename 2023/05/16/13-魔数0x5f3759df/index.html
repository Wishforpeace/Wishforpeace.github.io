

<!DOCTYPE html>
<html lang="en" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/fluid.png">
  <link rel="icon" href="/img/fluid.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="WYX ">
  <meta name="keywords" content="">
  
    <meta name="description" content="13 | 魔数 0x5f3759df你好，我是陈皓，网名左耳朵耗子。 下列代码是在《雷神之锤III竞技场》源代码中的一个函数（已经剥离了C语言预处理器的指令）。其实，最早在2002年（或2003年）时，这段平方根倒数速算法的代码就已经出现在Usenet与其他论坛上了，并且也在程序员圈子里引起了热烈的讨论。 我先把这段代码贴出来，具体如下： 123456789101112131415161718fl">
<meta property="og:type" content="article">
<meta property="og:title" content="WYX同学的Blog">
<meta property="og:url" content="http://example.com/2023/05/16/13-%E9%AD%94%E6%95%B00x5f3759df/index.html">
<meta property="og:site_name" content="WYX同学的Blog">
<meta property="og:description" content="13 | 魔数 0x5f3759df你好，我是陈皓，网名左耳朵耗子。 下列代码是在《雷神之锤III竞技场》源代码中的一个函数（已经剥离了C语言预处理器的指令）。其实，最早在2002年（或2003年）时，这段平方根倒数速算法的代码就已经出现在Usenet与其他论坛上了，并且也在程序员圈子里引起了热烈的讨论。 我先把这段代码贴出来，具体如下： 123456789101112131415161718fl">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="http://example.com/2023/05/16/13-%E9%AD%94%E6%95%B00x5f3759df/images/730/cfb465ac3800ceb3f8a8997fe527c8a2.jpg">
<meta property="og:image" content="http://example.com/2023/05/16/13-%E9%AD%94%E6%95%B00x5f3759df/images/730/7d607f3f90fe6e8152e2268da18e1feb.png">
<meta property="og:image" content="http://example.com/2023/05/16/13-%E9%AD%94%E6%95%B00x5f3759df/images/730/3f99e711a80ebe963bd5ca4139224915.jpg">
<meta property="og:image" content="http://example.com/2023/05/16/13-%E9%AD%94%E6%95%B00x5f3759df/images/730/bd3c8cae032d818084f2d1ac0a02acde.jpg">
<meta property="og:image" content="http://example.com/2023/05/16/13-%E9%AD%94%E6%95%B00x5f3759df/images/730/2d2b69795d3aa4d07545f0bbe645574e.png">
<meta property="og:image" content="http://example.com/2023/05/16/13-%E9%AD%94%E6%95%B00x5f3759df/images/730/d9c070d857b29966ecb9eeab49057ce0.jpg">
<meta property="article:published_time" content="2023-05-16T07:45:45.590Z">
<meta property="article:modified_time" content="2023-05-16T07:45:45.591Z">
<meta property="article:author" content="WYX ">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="http://example.com/2023/05/16/13-%E9%AD%94%E6%95%B00x5f3759df/images/730/cfb465ac3800ceb3f8a8997fe527c8a2.jpg">
  
  
  
  <title>WYX同学的Blog</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  




  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"example.com","root":"/","version":"1.9.2","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":false,"follow_dnt":true,"baidu":null,"google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false}},"search_path":"/local-search.xml"};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  


  
<!-- hexo injector head_end start -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css">
<!-- hexo injector head_end end --><meta name="generator" content="Hexo 6.2.0"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>WYX&#39;s Blog</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                Home
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                Archives
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                Categories
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                Tags
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                About
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              &nbsp;<i class="iconfont icon-search"></i>&nbsp;
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">&nbsp;<i
                class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/img/default.png') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text=""></span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2023-05-16 15:45" pubdate>
          May 16, 2023 pm
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          6.8k words
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          57 mins
        
      </span>
    

    
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none"></h1>
            
            
              <div class="markdown-body">
                
                <h1 id="13-魔数-0x5f3759df"><a href="#13-魔数-0x5f3759df" class="headerlink" title="13 | 魔数 0x5f3759df"></a>13 | 魔数 0x5f3759df</h1><p>你好，我是陈皓，网名左耳朵耗子。</p>
<p>下列代码是在《雷神之锤III竞技场》源代码中的一个函数（已经剥离了C语言预处理器的指令）。其实，最早在2002年（或2003年）时，这段平方根倒数速算法的代码就已经出现在Usenet与其他论坛上了，并且也在程序员圈子里引起了热烈的讨论。</p>
<p>我先把这段代码贴出来，具体如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">float</span> <span class="hljs-title function_">Q_rsqrt</span><span class="hljs-params">( <span class="hljs-type">float</span> number )</span><br>&#123;<br>    <span class="hljs-type">long</span> i;<br>    <span class="hljs-type">float</span> x2, y;<br>    <span class="hljs-type">const</span> <span class="hljs-type">float</span> threehalfs = <span class="hljs-number">1.5F</span>;<br><br>    x2 = number * <span class="hljs-number">0.5F</span>;<br>    y  = number;<br>    i  = * ( <span class="hljs-type">long</span> * ) &amp;y; <span class="hljs-comment">// evil floating point bit level hacking</span><br>    i  = <span class="hljs-number">0x5f3759df</span> - ( i &gt;&gt; <span class="hljs-number">1</span> );  <span class="hljs-comment">// what the fuck?</span><br>    y  = * ( <span class="hljs-type">float</span> * ) &amp;i;<br>    y  = y * ( threehalfs - ( x2 * y * y ) );  <span class="hljs-comment">// 1st iteration</span><br>    <span class="hljs-comment">// 2nd iteration, this can be removed</span><br>    <span class="hljs-comment">// y  = y * ( threehalfs - ( x2 * y * y ) );</span><br><br>    <span class="hljs-keyword">return</span> y;<br>&#125;<br><br></code></pre></td></tr></table></figure>
<p>这段代码初读起来，我是完全不知所云，尤其是那个魔数0x5f3759df，根本不知道它是什么意思，所以，注释里也是 What the fuck。今天这节课，我主要就是想带你来了解一下这个函数中的代码究竟是怎样出来的。</p>
<p>其实，这个函数的作用是求平方根倒数，即$x^{-1/2}$，也就是下面这个算式：</p>
<script type="math/tex; mode=display">\\frac{1}{\\sqrt{x}}</script><p>当然，它算的是近似值。只不过这个近似值的精度很高，而且计算成本比传统的浮点数运算平方根的算法低太多。在以前那个计算资源还不充分的年代，在一些3D游戏场景的计算机图形学中，要求取照明和投影的光照与反射效果，就经常需要计算平方根倒数，而且是大量的计算——对一个曲面上很多的点做平方根倒数的计算。也就是需要用到下面的这个算式，其中的x,y,z是3D坐标上的一个点的三个坐标值。</p>
<script type="math/tex; mode=display">\\frac{1}{\\sqrt{x^{2}+y^{2}+z^{2}}}</script><p>基本上来说，在一个3D游戏中，我们每秒钟都需要做上百万次平方根倒数运算。而在计算硬件还不成熟的时代，这些计算都需要软件来完成，计算速度非常慢。</p>
<p>我们要知道，在上世纪90年代，多数浮点数操作的速度更是远远滞后于整数操作。所以，这段代码所带来的作用是非常大的。</p>
<h1 id="计算机的浮点数表示"><a href="#计算机的浮点数表示" class="headerlink" title="计算机的浮点数表示"></a>计算机的浮点数表示</h1><p>为了讲清楚这段代码，我们需要先了解一下计算机的浮点数表示法。在C语言中，计算机的浮点数表示用的是IEEE 754 标准，这个标准的表现形式其实就是把一个32bits分成三段。</p>
<ul>
<li>第一段占1bit，表示符号位。代称为S（sign）。</li>
<li>第二段占8bits，表示指数。代称为E（Exponent）。</li>
<li>第三段占23bits，表示尾数。代称为M（Mantissa）。</li>
</ul>
<p>如下图所示：</p>
<p><img src="images/730/cfb465ac3800ceb3f8a8997fe527c8a2.jpg" srcset="/img/loading.gif" lazyload alt=""></p>
<p>然后呢，一个小数的计算方式是下面这个算式：</p>
<script type="math/tex; mode=display">(-1)^{S}\\ast(1+\\frac{M}{2^{23}})\\ast 2^{(E-127)}</script><p>但是，这个算式基本上来说，完全就是让人一头雾水，摸不着门路。对于浮点数的解释基本上就是下面这张漫画里表现的样子。</p>
<p><img src="images/730/7d607f3f90fe6e8152e2268da18e1feb.png" srcset="/img/loading.gif" lazyload alt=""></p>
<p>下面，让我来试着解释一下浮点数的那三段表示什么意思。</p>
<ul>
<li><p>第一段符号位。对于这一段，我相信应该没有人不能理解。</p>
</li>
<li><p>第二段指数位。什么叫指数？也就是说，对于任何数x，其都可以找到一个$n$，使得$2^{n}$&lt;=x&lt;=$2^{n+1}$。比如：对于3来说，因为 2 &lt; 3 &lt; 4，所以 n=1。而浮点数的这个指数为了要表示0.00x的小数，所以需要有负数，这8个bits本来可以表示0-255。为了表示负的，取值要放在 [-127,128] 这个区间中。这就是为什么我们在上面的公式中看到的 $2^{(E-127)}$这一项了。也就是说，$n = E-127$，如果$n=1$，那么$E$就是128了。</p>
</li>
<li><p>第三段尾数位。也就是小数位，但是这里叫偏移量可能好一些。这里的取值是在[ 0 - $2^{23}$]中。你可以认为，我们把一条线分成$2^{23}$个线段，也就是8388608个线段。也就是说，把$2^{n}$到$2^{n+1}$分成了8388608个线段。而存储的M值，就是从$2^n$到 x 要经过多少个段。这要计算一下，$2^{n}$到x的长度占$2^{n}$到$2^{n+1}$长度的比例是多少。</p>
</li>
</ul>
<p>我估计你对第三段还是有点不懂，那么我们来举一个例子。比如说，对3.14这个小数。</p>
<ul>
<li><p>是正数。所以，S = 0。</p>
</li>
<li><p>$2^1$ &lt; 3.14 &lt;$2^2$。所以，n=1， n+127 = 128。所以，E=128。</p>
</li>
<li><p>(3.14 - 2) / (4 - 2) = 0.57， 而$0.57*2^{23} = 4781506.56$，四舍五入，得到M = 4781507。因为有四舍五入，所以，产生了浮点数据的精度问题。</p>
</li>
</ul>
<p>把S、E、M转成二进制，得到 3.14的二进制表示。</p>
<p><img src="images/730/3f99e711a80ebe963bd5ca4139224915.jpg" srcset="/img/loading.gif" lazyload alt=""></p>
<p>我们再用IEEE 754的那个算式来算一下：</p>
<script type="math/tex; mode=display">{(-1)}^0\*({1+\\frac{4781507}{2^{23}}})\*2^{(128-127)}</script><script type="math/tex; mode=display">=1\*(1+0.5700000524520874)\*2</script><script type="math/tex; mode=display">=3.1400001049041748046875</script><p>你看，浮点数的精度问题出现了。</p>
<p>我们再来看一个示例，小数 0.015。</p>
<ul>
<li><p>是正数。所以，S = 0。</p>
</li>
<li><p>$2^{-7}&lt; 0.015 &lt; 2^{-6}$ 。所以，n=-7， n+127 = 120。所以，E=120。</p>
</li>
<li><p>$ (0.015 - 2^{-7}) / (2^{-6} - 2^{-7}) $ = $0.0071875/0.0078125=0.92$。而$0.92 * 2^{23} = 7717519.36$，四舍五入，得到 M = 7717519。</p>
</li>
</ul>
<p>于是，我们得到0.015的二进制编码：</p>
<p><img src="images/730/bd3c8cae032d818084f2d1ac0a02acde.jpg" srcset="/img/loading.gif" lazyload alt=""></p>
<p>其中：</p>
<ul>
<li>120 的二进制是01111000</li>
<li>7717519的二进制是11101011100001010001111</li>
</ul>
<p>返回过来算一下：</p>
<script type="math/tex; mode=display">(-1)^{0}\\ast (1+\\frac{7717519}{2^{23}})\\ast 2^{(120-127)}</script><script type="math/tex; mode=display">=(1+0.919999957084656)\*0.0078125</script><script type="math/tex; mode=display">=0.014999999664724</script><p>你看，浮点数的精度问题又出现了。</p>
<p>我们来用C语言验证一下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-type">float</span> x = <span class="hljs-number">3.14</span>;<br>    <span class="hljs-type">float</span> y = <span class="hljs-number">0.015</span>;<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br></code></pre></td></tr></table></figure>
<p>在我的Mac上用lldb 工具 Debug 一下。</p>
<figure class="highlight maxima"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs maxima">(lldb) frame variable<br>(<span class="hljs-built_in">float</span>) x = <span class="hljs-number">3.1400001</span><br>(<span class="hljs-built_in">float</span>) y = <span class="hljs-number">0.0149999997</span><br><br>(lldb) frame variable -f b<br>(<span class="hljs-built_in">float</span>) x = <span class="hljs-number">0b01000000010010001111010111000011</span><br>(<span class="hljs-built_in">float</span>) y = <span class="hljs-number">0b00111100011101011100001010001111</span><br><br></code></pre></td></tr></table></figure>
<p>从结果上，完全验证了我们的方法。</p>
<p>好了，不知道你看懂了没有？我相信你应该看懂了。</p>
<h1 id="简化浮点数公式"><a href="#简化浮点数公式" class="headerlink" title="简化浮点数公式"></a>简化浮点数公式</h1><p>因为那个浮点数表示的公式有点复杂，我们简化一下：</p>
<script type="math/tex; mode=display">(-1)^{S}\\ast (1+\\frac{M}{2^{23}})\\ast 2^{(E-127)}</script><p>我们令，$m = (\\frac{M}{2^{23}} )$，$e = (E-127)$。因为符号位在$y= x^{-\\frac{1}{2}}$的两端都是0（正数），也就可以去掉，所以浮点数的算式简化为：</p>
<script type="math/tex; mode=display">(1+m)\\ast2^{e}</script><p>上面这个算式是从一个32bits二进制计算出一个浮点数。这个32bits的整型算式是：</p>
<script type="math/tex; mode=display">M+E\\ast2^{23}</script><p>比如，0.015的32bits的二进制是：00111100011101011100001010001111，也就是整型的：</p>
<script type="math/tex; mode=display">7717519+120\\ast 2^{23}</script><script type="math/tex; mode=display">= 1014350479</script><script type="math/tex; mode=display">= 0X3C75C28F</script><h1 id="平方根倒数公式推导"><a href="#平方根倒数公式推导" class="headerlink" title="平方根倒数公式推导"></a>平方根倒数公式推导</h1><p>下面，你会看到好多数学公式，但是请你不要怕，因为这些数学公式只需要高中数学就能看懂的。</p>
<p>我们来看一下，平方根数据公式：</p>
<script type="math/tex; mode=display">y=\\frac{1}{\\sqrt\[2\]{x}}=x^{-\\frac{1}{2}}</script><p>等式两边取以2为基数的对数，就有了：</p>
<script type="math/tex; mode=display">\\log\_2(y) =-\\frac{1}{2}\\log\_2(x)</script><p>因为我们实际上在算浮点数，所以将公式中的 x 和 y 分别用浮点数的那个浮点数的简化算式$ (1+ m)*2^e$替换掉。代入$\\log()$公式中，我们也就有了下面的公式：</p>
<script type="math/tex; mode=display">\\log\_{2} (1+m\_y)+e\_y</script><script type="math/tex; mode=display">=-\\frac{1}{2}(\\log\_2(1+m\_x)+e\_x)</script><p>因为有对数，这公式看着就很麻烦，似乎不能再简化了。但是，我们知道，所谓的$m_x$或是$m_y$，其实是个在0和1区间内的小数。在这种情况下，$\\log_2 (1.x)$接近一条直线。</p>
<p><img src="images/730/2d2b69795d3aa4d07545f0bbe645574e.png" srcset="/img/loading.gif" lazyload alt=""></p>
<p>那么我们就可以使用一个直线方程来代替，也就是：</p>
<script type="math/tex; mode=display">\\log\_{2}(1+m)\\approx m+\\sigma</script><p>于是，我们的公式就简化成了：</p>
<script type="math/tex; mode=display">m\_y+\\sigma+e\_y\\approx-\\frac{1}{2}(m\_x+\\sigma+e\_x)</script><p>因为$m = (\\frac{M}{2^{23}})$，$e = (E-127)$，代入公式，得到：</p>
<script type="math/tex; mode=display">\\frac{M\_y}{2^{23}}+\\sigma+E\_y-127</script><script type="math/tex; mode=display">\\approx-\\frac{1}{2}(\\frac{M\_x}{2^{23}}+\\sigma+E\_x-127)</script><p>移项整理一下，把 σ 和127 从左边，移到右边：</p>
<script type="math/tex; mode=display">\\frac{M\_y}{2^{23}}+E\_y\\approx-\\frac{1}{2}(\\frac{M\_x}{2^{23}}+E\_x)-\\frac{3}{2}(\\sigma-127)</script><p>再把整个表达式乘以$2^{23}$，得到：</p>
<script type="math/tex; mode=display">{M\_y}+E\_y{2^{23}}</script><script type="math/tex; mode=display">\\approx-\\frac{1}{2}(M\_x+E\_x{2^{23}})-\\frac{3}{2}(\\sigma-127){2^{23}}</script><p>可以看到一个常数：$-\\frac{3}{2}(\\sigma-127){2^{23}}$，把负号放进括号里，变成$\\frac{3}{2}(127-\\sigma){2^{23}}$，并可以用一个常量代数R来取代，于是得到公式：</p>
<script type="math/tex; mode=display">{M\_y}+E\_y{2^{23}}\\approx R-\\frac{1}{2}(M\_x+E\_x{2^{23}})</script><p>还记得我们前面那个“浮点数32bits二进制整型算式” $M+E* 2^{23}$吗？假设，浮点数x的32bits的整型公式是：$I_x= M_x+ E_x 2^{23}$，那么上面的公式就可以写成：</p>
<script type="math/tex; mode=display">I\_y\\approx R-\\frac{1}{2}I\_x</script><h1 id="代码分析"><a href="#代码分析" class="headerlink" title="代码分析"></a>代码分析</h1><p>让我们回到文章的主题，那个平方根函数的代码。</p>
<p>首先是：</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-attr">i</span>  = * ( long * ) &amp;y<span class="hljs-comment">; // evil floating point bit level hacking</span><br><br></code></pre></td></tr></table></figure>
<p>这行代码就是把一个浮点数的32bits的二进制转成整型。也就是，前面我们例子里说过的，3.14的32bits的二进制是：01000000010010001111010111000011，整型是：1078523331。即y = 3.14，i = 1078523331。</p>
<p>然后是：</p>
<figure class="highlight abnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs abnf"><span class="hljs-attribute">i</span>  <span class="hljs-operator">=</span> <span class="hljs-number">0</span>x5f3759df - ( i &gt;&gt; <span class="hljs-number">1</span> )<span class="hljs-comment">;  // what the fuck?</span><br><br></code></pre></td></tr></table></figure>
<p>这就是：</p>
<figure class="highlight abnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs abnf"><span class="hljs-attribute">i</span>  <span class="hljs-operator">=</span> <span class="hljs-number">0</span>x5f3759df - ( i / <span class="hljs-number">2</span> )<span class="hljs-comment">;</span><br><br></code></pre></td></tr></table></figure>
<p>也就是我们上面推导出来的那个公式：</p>
<script type="math/tex; mode=display">I\_y\\approx R-\\frac{1}{2}I\_x</script><p>代码里的 R = 0x5f3759df。</p>
<p>我们又知道，R = $\\frac{3}{2}(127-\\sigma){2^{23}}$，把代码中的那个魔数代入，就可以计算出来：σ= 0.0450465 。这个数是个神奇的数字，这个数是怎么算出来的，现在还没人知道。不过，我们先往下看后面的代码：</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs awk">x2 = number * <span class="hljs-number">0.5</span>F;<br>y  = * ( float * ) &amp;i;<br>y  = y * ( threehalfs - ( x2 * y * y ) );  <span class="hljs-regexp">//</span> <span class="hljs-number">1</span>st iteration<br><span class="hljs-regexp">//</span> <span class="hljs-number">2</span>nd iteration, this can be removed<br><span class="hljs-regexp">//</span> y  = y * ( threehalfs - ( x2 * y * y ) );<br><br></code></pre></td></tr></table></figure>
<p>这段代码相当于下面这个公式：</p>
<script type="math/tex; mode=display">I\_{y’} = I\_y(1.5-0.5 x I\_y^2)</script><p>这个其实是“牛顿求根法”，这是一个为了找到一个 f(x)= 0 的根而用一种不断逼近的计算方式。请看下图：</p>
<p><img src="images/730/d9c070d857b29966ecb9eeab49057ce0.jpg" srcset="/img/loading.gif" lazyload alt=""></p>
<p>首先，初始值为X0，然后找到X0所对应的Y0（把X0代入公式得到Y0 = f(X0)），然后在（X0,Y0）这个点上做一个切线，得到与X轴交汇的X1。再用X1做一次上述的迭代，得到X2，就这样一直迭代下去，一直找到，y = 0时，x的值。</p>
<p>牛顿法的通用公式是：</p>
<script type="math/tex; mode=display">x\_{n+1}=x\_n-\\frac{f(x\_n)}{f’(x\_n)}</script><p>于是，对于$y= \\frac{1}{\\sqrt{x}}$来说，对固定的x（常数），我们求y使得$\\frac{1}{y^2}-x=0$，$f(y)= \\frac{1}{y^2} -x$ , $f’(y)=\\frac{-2}{y^3}$ 。 注意：$f’(y)$是$f(y)$关于y的导数。</p>
<p>代入上述的牛顿法的通用公式后得到：</p>
<script type="math/tex; mode=display">y\_{n+1}=y\_n-\\frac{\\frac{1}{y\_n^2}-x}{\\frac{-2}{y\_n^3}}</script><script type="math/tex; mode=display">=\\frac{y\_n(3-xy\_n^2)}{2}=y\_n(1.5-0.5xy\_n^2)</script><p>正好就是我们上面的代码。</p>
<p>整个代码是，之前生成的整数操作产生首次近似值后，将首次近似值作为参数送入函数最后两句进行精化处理。代码中的两次迭代正是为了进一步提高结果的精度。但由于《雷神之锤III》的图形计算中并不需要太高的精度，所以代码中只进行了一次迭代，二次迭代的代码则被注释了。</p>
<h1 id="相关历史"><a href="#相关历史" class="headerlink" title="相关历史"></a>相关历史</h1><p>根据Wikipedia上的描述，《雷神之锤III》的代码直到QuakeCon 2005才正式放出，但早在2002年（或2003年）时，平方根倒数速算法的代码就已经出现在Usenet和其他论坛上了。最初人们猜测是《雷神之锤》的创始人John Carmack写下了这段代码，但他在回复询问他的邮件时否定了这个观点，并猜测可能是先前曾帮id Software优化《雷神之锤》的资深汇编程序员Terje Mathisen写下了这段代码。</p>
<p>而Mathisen的邮件里表示，在1990年代初，他只曾做过类似的实现，确切来说这段代码亦非他所作。现在所知的最早实现是由Gary Tarolli在SGI Indigo中实现的，但他亦坦承他仅对常数R的取值做了一定的改进，实际上他也不是作者。</p>
<p>在向以发明MATLAB而闻名的Cleve Moler查证后，Rys Sommefeldt则认为原始的算法是Ardent Computer公司的Greg Walsh所发明的，但他也没有任何确定性的证据能证明这一点。</p>
<p>不仅该算法的原作者不明，人们也仍无法确定当初选择这个“魔术数字”的方法。Chris Lomont曾做了个研究：他推算出了一个函数以讨论此速算法的误差，并找出了使误差最小的最佳R值0x5f37642f（与代码中使用的0x5f3759df相当接近）。但以之代入算法计算并进行一次牛顿迭代后，所得近似值之精度仍略低于代入0x5f3759df的结果。</p>
<p>因此，Lomont将目标改为查找在进行1-2次牛顿迭代后能得到最大精度的R值，在暴力搜索后得出最优R值为0x5f375a86，以此值代入算法并进行牛顿迭代，所得的结果都比代入原始值（0x5f3759df）更精确。于是他说，“如果可能我想询问原作者，此速算法是以数学推导还是以反复试错的方式求出来的？”</p>
<p>Lomont亦指出，64位的IEEE754浮点数（即双精度类型）所对应的魔术数字是0x5fe6ec85e7de30da。但后来的研究表明，代入0x5fe6eb50c7aa19f9的结果精确度更高（McEniry得出的结果则是0x5fe6eb50c7b537aa，精度介于两者之间）。</p>
<p>后来Charles McEniry使用了一种类似Lomont但更复杂的方法来优化R值。他最开始使用穷举搜索，所得结果与Lomont相同。而后他尝试用带权二分法寻找最优值，所得结果恰是代码中所使用的魔术数字0x5f3759df。因此，McEniry认为，这一常数最初或许便是以“在可容忍误差范围内使用二分法”的方式求得。</p>
<p>这可能是编程世界里最经典的魔数的故事，希望你能够从这节课中收获一些数学的基础知识。数学真是需要努力学习好的一门功课，尤其在人工智能火热的今天。</p>

                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div></div>
      <div>http://example.com/2023/05/16/13-魔数0x5f3759df/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>Author</div>
          <div>WYX </div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>Posted on</div>
          <div>May 16, 2023</div>
        </div>
      
      
      <div class="license-meta-item">
        <div>Licensed under</div>
        <div>
          
            
            
              <a target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
              <span class="hint--top hint--rounded" aria-label="BY - Attribution">
                <i class="iconfont icon-by"></i>
              </span>
              </a>
            
          
        </div>
      </div>
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2023/05/16/14-%E6%8E%A8%E8%8D%90%E9%98%85%E8%AF%BB%EF%BC%9A%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0101/" title="">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile"></span>
                        <span class="visible-mobile">Previous</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2023/05/16/12-%E7%A8%8B%E5%BA%8F%E4%B8%AD%E7%9A%84%E9%94%99%E8%AF%AF%E5%A4%84%E7%90%86%EF%BC%9A%E5%BC%82%E6%AD%A5%E7%BC%96%E7%A8%8B%E4%BB%A5%E5%8F%8A%E6%88%91%E7%9A%84%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5/" title="">
                        <span class="hidden-mobile"></span>
                        <span class="visible-mobile">Next</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;Table of Contents</p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  


  
  









    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">Search</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">Keyword</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a>
    </div>
  
  
  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.0/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.18.2/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      headingSelector : CONFIG.toc.headingSelector || 'h1,h2,h3,h4,h5,h6',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      collapseDepth   : CONFIG.toc.collapseDepth || 0,
      scrollSmooth    : true,
      headingsOffset  : -boardTop
    });
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.10/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  
      <script>
        if (!window.MathJax) {
          window.MathJax = {
            tex    : {
              inlineMath: { '[+]': [['$', '$']] }
            },
            loader : {
              load: ['ui/lazy']
            },
            options: {
              renderActions: {
                insertedScript: [200, () => {
                  document.querySelectorAll('mjx-container').forEach(node => {
                    let target = node.parentNode;
                    if (target.nodeName.toLowerCase() === 'li') {
                      target.parentNode.classList.add('has-jax');
                    }
                  });
                }, '', false]
              }
            }
          };
        } else {
          MathJax.startup.document.state(0);
          MathJax.texReset();
          MathJax.typeset();
          MathJax.typesetPromise();
        }
      </script>
    

  <script  src="https://lib.baomitu.com/mathjax/3.2.1/es5/tex-mml-chtml.js" ></script>

  <script  src="/js/local-search.js" ></script>





<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">Blog works best with JavaScript enabled</div>
  </noscript>
</body>
</html>
